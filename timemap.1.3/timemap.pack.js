/* 
 * TimeMap Copyright 2008 Nick Rabinowitz.
 * Licensed under the MIT License (see LICENSE.txt)
 */
function TimeMap(A,D,B){this.mElement=D;this.tElement=A;this.datasets={};this.filters={};this.mapBounds=new GLatLngBounds();this.opts=B||{};if(typeof (B.mapType)=="string"){B.mapType=TimeMap.mapTypes[B.mapType]}this.opts.mapCenter=B.mapCenter||new GLatLng(0,0);this.opts.mapZoom=B.mapZoom||0;this.opts.mapType=B.mapType||G_PHYSICAL_MAP;this.opts.mapTypes=B.mapTypes||[G_NORMAL_MAP,G_SATELLITE_MAP,G_PHYSICAL_MAP];this.opts.syncBands=("syncBands" in B)?B.syncBands:true;this.opts.showMapTypeCtrl=("showMapTypeCtrl" in B)?B.showMapTypeCtrl:true;this.opts.showMapCtrl=("showMapCtrl" in B)?B.showMapCtrl:true;this.opts.hidePastFuture=("hidePastFuture" in B)?B.hidePastFuture:true;this.opts.showMomentOnly=("showMomentOnly" in B)?B.showMomentOnly:false;this.opts.centerMapOnItems=("centerMapOnItems" in B)?B.centerMapOnItems:true;if(GBrowserIsCompatible()){this.map=new GMap2(this.mElement);if(this.opts.showMapCtrl){this.map.addControl(new GLargeMapControl())}if(this.opts.showMapTypeCtrl){this.map.addControl(new GMapTypeControl())}for(var C=G_DEFAULT_MAP_TYPES.length-1;C>0;C--){this.map.removeMapType(G_DEFAULT_MAP_TYPES[C])}this.map.addMapType(this.opts.mapTypes[0]);this.map.removeMapType(G_DEFAULT_MAP_TYPES[0]);for(var C=1;C<this.opts.mapTypes.length;C++){this.map.addMapType(this.opts.mapTypes[C])}this.map.enableDoubleClickZoom();this.map.enableScrollWheelZoom();this.map.enableContinuousZoom();this.map.setCenter(this.opts.mapCenter,this.opts.mapZoom);this.map.setMapType(this.opts.mapType)}Timeline.DurationEventPainter.prototype._showBubble=function(E,G,F){F.item.openInfoWindow()}}TimeMap.init=function(D){if(!("mapId" in D)||!D.mapId){alert("TimeMap init: No map id was specified!");return }if(!("timelineId" in D)||!D.timelineId){alert("TimeMap init: No timeline id was specified!");return }D=D||{};D.options=D.options||{};D.datasets=D.datasets||[];D.bandInfo=D.bandInfo||false;D.scrollTo=D.scrollTo||"earliest";if(!D.bandInfo){var I=D.bandIntervals||D.options["bandIntervals"]||[Timeline.DateTime.WEEK,Timeline.DateTime.MONTH];if(typeof (I)=="string"){I=TimeMap.intervals[I]}D.options["bandIntervals"]=I;D.bandInfo=[{width:"80%",intervalUnit:I[0],intervalPixels:70},{width:"20%",intervalUnit:I[1],intervalPixels:100,showEventText:false,trackHeight:0.4,trackGap:0.2}]}var L=new TimeMap(document.getElementById(D.timelineId),document.getElementById(D.mapId),D.options);var H=[];for(var K=0;K<D.datasets.length;K++){var C=D.datasets[K];var F=C.options||{};F.title=C.title||"";F.theme=C.theme||undefined;if(C.dateParser){F.dateParser=C.dateParser}var B=C.id||"ds"+K;H[K]=L.createDataset(B,F);if(K>0){H[K].eventSource=H[0].eventSource}}var G=[];var E=(H[0]&&H[0]["eventSource"])||new Timeline.DefaultEventSource();for(var K=0;K<D.bandInfo.length;K++){var J=D.bandInfo[K];if(!(("eventSource" in J)&&J.eventSource==null)){J.eventSource=E}else{J.eventSource=null}G[K]=Timeline.createBandInfo(J);if(K>0){G[K].eventPainter.setLayout(G[0].eventPainter.getLayout())}}L.initTimeline(G);var A={};A.count=0;A.loadTarget=D.datasets.length;A.ifLoadedFunction=function(){if(D.dataLoadedFunction){D.dataLoadedFunction(L)}else{var M=new Date();if(E.getCount()>0){if(D.scrollTo=="earliest"){M=E.getEarliestDate()}else{if(D.scrollTo!="now"&&D.scrollTo!=null){M=E.getLatestDate()}}L.timeline.getBand(0).setCenterVisibleDate(M)}L.timeline.layout();if(D.dataDisplayedFunction){D.dataDisplayedFunction(L)}}};A.ifLoaded=function(){this.count++;if(this.count==this.loadTarget){this.ifLoadedFunction()}};for(var K=0;K<D.datasets.length;K++){(function(M){var R=D.datasets[M]["data"];var Q=H[M];var S=function(T){return T};var P=D.datasets[M]["preloadFunction"]||S;var O=D.datasets[M]["transformFunction"]||S;switch(R.type){case"basic":var N=P(R.value);Q.loadItems(N,O);A.ifLoaded();break;case"json":JSONLoader.read(R.url,function(T){var U=P(T);Q.loadItems(U,O);A.ifLoaded()});break;case"kml":GDownloadUrl(R.url,function(T){var U=TimeMapDataset.parseKML(T);U=P(U);Q.loadItems(U,O);A.ifLoaded()});break;case"metaweb":Metaweb.read(R.query,function(T){var U=P(T);Q.loadItems(T,O);A.ifLoaded()});break}})(K)}return L};var timemapInit=TimeMap.init;TimeMap.intervals={sec:[Timeline.DateTime.SECOND,Timeline.DateTime.MINUTE],min:[Timeline.DateTime.MINUTE,Timeline.DateTime.HOUR],hr:[Timeline.DateTime.HOUR,Timeline.DateTime.DAY],day:[Timeline.DateTime.DAY,Timeline.DateTime.WEEK],wk:[Timeline.DateTime.WEEK,Timeline.DateTime.MONTH],mon:[Timeline.DateTime.MONTH,Timeline.DateTime.YEAR],yr:[Timeline.DateTime.YEAR,Timeline.DateTime.DECADE],dec:[Timeline.DateTime.DECADE,Timeline.DateTime.CENTURY]};TimeMap.mapTypes={normal:G_NORMAL_MAP,satellite:G_SATELLITE_MAP,hybrid:G_HYBRID_MAP,physical:G_PHYSICAL_MAP,moon:G_MOON_VISIBLE_MAP,sky:G_SKY_VISIBLE_MAP};TimeMap.prototype.createDataset=function(D,B){B=B||{};if(!("title" in B)){B.title=D}var C=new TimeMapDataset(this,B);this.datasets[D]=C;if(this.opts.centerMapOnItems){var A=this;GEvent.addListener(C,"itemsloaded",function(){A.map.setZoom(A.map.getBoundsZoomLevel(A.mapBounds));A.map.setCenter(A.mapBounds.getCenter())})}return C};TimeMap.prototype.each=function(A){for(id in this.datasets){A(this.datasets[id])}};TimeMap.prototype.initTimeline=function(D){for(var A=1;A<D.length;A++){if(this.opts.syncBands){D[A].syncWith=(A-1)}D[A].highlight=true}this.timeline=Timeline.create(this.tElement,D);var B=this;this.timeline.getBand(0).addOnScrollListener(function(){B.filter("map")});GEvent.addListener(B.map,"moveend",function(){B.filter("timeline")});this.addFilterChain("map",function(E){E.showPlacemark()},function(E){E.hidePlacemark()});this.addFilter("map",function(E){return E.dataset.visible});if(this.opts.hidePastFuture){this.addFilter("map",TimeMap.hidePastFuture)}else{if(this.opts.showMomentOnly){this.addFilter("map",TimeMap.showMomentOnly)}}resizeTimerID=null;var C=this.timeline;window.onresize=function(){if(resizeTimerID==null){resizeTimerID=window.setTimeout(function(){resizeTimerID=null;C.layout()},500)}}};TimeMap.prototype.filter=function(B){var A=this.filters[B];if(!A||!A.chain||A.chain.length==0){return }this.each(function(C){C.each(function(E){F_LOOP:{for(var D=A.chain.length-1;D>=0;D--){if(!A.chain[D](E)){A.off(E);break F_LOOP}}A.on(E)}})})};TimeMap.prototype.addFilterChain=function(C,B,A){this.filters[C]={chain:[],on:B,off:A}};TimeMap.prototype.removeFilterChain=function(C,A,B){this.filters[C]=null};TimeMap.prototype.addFilter=function(B,A){if(this.filters[B]&&this.filters[B].chain){this.filters[B].chain.push(A)}};TimeMap.prototype.removeFilter=function(A){if(this.filters[A]&&this.filters[A].chain){this.filters[A].chain.pop()}};TimeMap.hidePastFuture=function(D){var F=D.dataset.timemap.timeline.getBand(0);var B=F.getMaxVisibleDate().getTime();var C=F.getMinVisibleDate().getTime();if(D.event!=null){var A=D.event.getStart().getTime();var E=D.event.getEnd().getTime();if(A>B){return false}else{if(E<C||(D.event.isInstant()&&A<C)){return false}}}return true};TimeMap.showMomentOnly=function(B){var D=B.dataset.timemap.timeline.getBand(0);var E=D.getCenterVisibleDate().getTime();if(B.event!=null){var A=B.event.getStart().getTime();var C=B.event.getEnd().getTime();if(A>E){return false}else{if(C<E||(B.event.isInstant()&&A<E)){return false}}}return true};function TimeMapDataset(A,B){this.timemap=A;this.eventSource=new Timeline.DefaultEventSource();this.items=[];this.visible=true;this.opts=B||{};this.opts.title=B.title||"";if(typeof (B.theme)=="string"){B.theme=TimeMapDataset.themes[B.theme]}this.opts.theme=B.theme||this.timemap.opts.theme||new TimeMapDatasetTheme({});this.opts.theme.eventIconPath=B.eventIconPath||this.timemap.opts.eventIconPath||this.opts.theme.eventIconPath;this.opts.theme.eventIcon=B.eventIconPath+this.opts.theme.eventIconImage;if(typeof (B.dateParser)=="string"){B.dateParser=TimeMapDataset.dateParsers[B.dateParser]}this.opts.dateParser=B.dateParser||TimeMapDataset.dateParsers.iso8601;this.getItems=function(){return this.items};this.getTitle=function(){return this.opts.title}}TimeMapDataset.dateParsers={iso8601:Timeline.DateTime.parseIso8601DateTime,gregorian:Timeline.DateTime.parseGregorianDateTime};TimeMapDataset.prototype.each=function(B){for(var A=0;A<this.items.length;A++){B(this.items[A])}};TimeMapDataset.prototype.loadItems=function(C,B){for(var A=0;A<C.length;A++){this.loadItem(C[A],B)}GEvent.trigger(this,"itemsloaded")};TimeMapDataset.prototype.loadItem=function(T,J){if(J!=undefined){T=J(T)}if(T==null){return }var E=T.options||{};if(typeof (E.theme)=="string"){E.theme=TimeMapDataset.themes[E.theme]}var S=E.theme||this.opts.theme;S.eventIconPath=E.eventIconPath||this.opts.theme.eventIconPath;S.eventIcon=S.eventIconPath+S.eventIconImage;var D=this.timemap;var H=(T.start==undefined||T.start=="")?null:this.opts.dateParser(T.start);var G=(T.end==undefined||T.end=="")?null:this.opts.dateParser(T.end);var C=(T.end==undefined);var B=S.eventIcon;var U=T.title;if(H!=null){var O=new Timeline.DefaultEventSource.Event(H,G,null,null,C,U,null,null,null,B,S.eventColor,null)}else{var O=null}var L=function(Y){var X=null,Z="",b=null;if("point" in Y){b=new GLatLng(parseFloat(Y.point.lat),parseFloat(Y.point.lon));if(D.opts.centerMapOnItems){D.mapBounds.extend(b)}markerIcon=("icon" in Y)?Y.icon:S.icon;X=new GMarker(b,{icon:markerIcon});Z="marker";b=X.getLatLng()}else{if("polyline" in Y||"polygon" in Y){var d=[];if("polyline" in Y){var e=Y.polyline}else{var e=Y.polygon}for(var a=0;a<e.length;a++){b=new GLatLng(parseFloat(e[a]["lat"]),parseFloat(e[a]["lon"]));d.push(b);if(D.opts.centerMapOnItems){D.mapBounds.extend(b)}}if("polyline" in Y){X=new GPolyline(d,S.lineColor,S.lineWeight,S.lineOpacity);Z="polyline";b=X.getVertex(Math.floor(X.getVertexCount()/2))}else{X=new GPolygon(d,S.polygonLineColor,S.polygonLineWeight,S.polygonLineOpacity,S.fillColor,S.fillOpacity);Z="polygon";b=X.getBounds().getCenter()}}else{if("overlay" in Y){var c=new GLatLng(parseFloat(Y.overlay.south),parseFloat(Y.overlay.west));var W=new GLatLng(parseFloat(Y.overlay.north),parseFloat(Y.overlay.east));if(D.opts.centerMapOnItems){D.mapBounds.extend(c);D.mapBounds.extend(W)}var V=new GLatLngBounds(c,W);X=new GGroundOverlay(Y.overlay.image,V);Z="overlay";b=V.getCenter()}}}return{placemark:X,type:Z,point:b}};var R=[],M=[],A=null,F="",N=null;if("placemarks" in T){M=T.placemarks}else{var I=["point","polyline","polygon","overlay"];for(var P=0;P<I.length;P++){if(I[P] in T){A={};A[I[P]]=T[I[P]];M.push(A)}}}if(M){for(var P=0;P<M.length;P++){var K=L(M[P]);if(!N){N=K.point}if(!F){F=K.type}R.push(K.placemark)}}if(R.length>1){F="array"}E.title=U;E.type=F||"none";E.theme=S;if(E.infoPoint){E.infoPoint=new GLatLng(parseFloat(E.infoPoint.lat),parseFloat(E.infoPoint.lon))}else{E.infoPoint=N}var Q=new TimeMapItem(R,O,this,E);if(O!=null){O.item=Q;this.eventSource.add(O)}if(R.length>0){for(var P=0;P<R.length;P++){R[P].item=Q;GEvent.addListener(R[P],"click",function(){Q.openInfoWindow()});D.map.addOverlay(R[P]);R[P].hide()}}this.items.push(Q);return Q};TimeMapDataset.parseKML=function(H){var G=[],D,B,I,A;B=GXml.parse(H);var E=function(Q,O){var P=Q.getElementsByTagName(O);if(P.length>0){return P[0].firstChild.nodeValue}else{return""}};var N=function(R,Q){var O=false;nList=R.getElementsByTagName("TimeStamp");if(nList.length>0){Q.start=E(nList[0],"when");O=true}else{nList=R.getElementsByTagName("TimeSpan");if(nList.length>0){Q.start=E(nList[0],"begin");Q.end=E(nList[0],"end");O=true}}if(!O){var P=R.parentNode;if(P.nodename=="Folder"||P.nodename=="Document"){TimeMapDataset.findNodeTime(P,Q)}P=null}};I=B.getElementsByTagName("Placemark");for(var C=0;C<I.length;C++){A=I[C];D={options:{}};D.title=E(A,"name");D.options.description=E(A,"description");N(A,D);PLACEMARK:{var L,M,F,J;nList=A.getElementsByTagName("Point");if(nList.length>0){D.point={};L=E(nList[0],"coordinates");F=L.split(",");D.point={lat:trim(F[1]),lon:trim(F[0])};break PLACEMARK}nList=A.getElementsByTagName("LineString");if(nList.length>0){J="polyline"}else{nList=A.getElementsByTagName("Polygon");if(nList.length>0){J="polygon"}}if(nList.length>0){D[J]=[];L=E(nList[0],"coordinates");M=trim(L).split(/[\r\n\f ]+/);for(var K=0;K<M.length;K++){F=M[K].split(",");D[J].push({lat:trim(F[1]),lon:trim(F[0])})}break PLACEMARK}}G.push(D)}I=B.getElementsByTagName("GroundOverlay");for(var C=0;C<I.length;C++){A=I[C];D={options:{},overlay:{}};D.title=E(A,"name");D.options.description=E(A,"description");N(A,D);nList=A.getElementsByTagName("Icon");D.overlay.image=E(nList[0],"href");nList=A.getElementsByTagName("LatLonBox");D.overlay.north=E(nList[0],"north");D.overlay.south=E(nList[0],"south");D.overlay.east=E(nList[0],"east");D.overlay.west=E(nList[0],"west");G.push(D)}B=null;I=null;A=null;nList=null;return G};function TimeMapDatasetTheme(B){B=B||{};if(!B.icon){var A=new GIcon(G_DEFAULT_ICON);this.iconImage=B.iconImage||"http://www.google.com/intl/en_us/mapfiles/ms/icons/red-dot.png";A.image=this.iconImage;A.iconSize=new GSize(32,32);A.shadow="http://www.google.com/intl/en_us/mapfiles/ms/icons/msmarker.shadow.png";A.shadowSize=new GSize(59,32)}this.icon=B.icon||A;this.color=B.color||"#FE766A";this.lineColor=B.lineColor||this.color;this.polygonLineColor=B.polygonLineColor||this.lineColor;this.lineOpacity=B.lineOpacity||1;this.polgonLineOpacity=B.polgonLineOpacity||this.lineOpacity;this.lineWeight=B.lineWeight||2;this.polygonLineWeight=B.polygonLineWeight||this.lineWeight;this.fillColor=B.fillColor||this.color;this.fillOpacity=B.fillOpacity||0.25;this.eventColor=B.eventColor||this.color;this.eventIconPath=B.eventIconPath||"timemap/images/";this.eventIconImage=B.eventIconImage||"red-circle.png";this.eventIcon=B.eventIcon||this.eventIconPath+this.eventIconImage}TimeMapDataset.redTheme=function(A){return new TimeMapDatasetTheme(A)};TimeMapDataset.blueTheme=function(A){A=A||{};A.iconImage="http://www.google.com/intl/en_us/mapfiles/ms/icons/blue-dot.png";A.color="#5A7ACF";A.eventIconImage="blue-circle.png";return new TimeMapDatasetTheme(A)};TimeMapDataset.greenTheme=function(A){A=A||{};A.iconImage="http://www.google.com/intl/en_us/mapfiles/ms/icons/green-dot.png";A.color="#19CF54";A.eventIconImage="green-circle.png";return new TimeMapDatasetTheme(A)};TimeMapDataset.ltblueTheme=function(A){A=A||{};A.iconImage="http://www.google.com/intl/en_us/mapfiles/ms/icons/ltblue-dot.png";A.color="#5ACFCF";A.eventIconImage="ltblue-circle.png";return new TimeMapDatasetTheme(A)};TimeMapDataset.purpleTheme=function(A){A=A||{};A.iconImage="http://www.google.com/intl/en_us/mapfiles/ms/icons/purple-dot.png";A.color="#8E67FD";A.eventIconImage="purple-circle.png";return new TimeMapDatasetTheme(A)};TimeMapDataset.orangeTheme=function(A){A=A||{};A.iconImage="http://www.google.com/intl/en_us/mapfiles/ms/icons/orange-dot.png";A.color="#FF9900";A.eventIconImage="orange-circle.png";return new TimeMapDatasetTheme(A)};TimeMapDataset.yellowTheme=function(A){A=A||{};A.iconImage="http://www.google.com/intl/en_us/mapfiles/ms/icons/yellow-dot.png";A.color="#ECE64A";A.eventIconImage="yellow-circle.png";return new TimeMapDatasetTheme(A)};TimeMapDataset.themes={red:TimeMapDataset.redTheme(),blue:TimeMapDataset.blueTheme(),green:TimeMapDataset.greenTheme(),ltblue:TimeMapDataset.ltblueTheme(),orange:TimeMapDataset.orangeTheme(),yellow:TimeMapDataset.yellowTheme(),purple:TimeMapDataset.purpleTheme()};function TimeMapItem(B,C,D,A){this.event=C;this.dataset=D;this.map=D.timemap.map;if(B&&isArray(B)&&B.length==0){B=null}if(B&&B.length==1){B=B[0]}this.placemark=B;this.opts=A||{};this.opts.type=A.type||"";this.opts.title=A.title||"";this.opts.description=A.description||"";this.opts.infoPoint=A.infoPoint||null;this.opts.infoHtml=A.infoHtml||"";this.opts.infoUrl=A.infoUrl||"";this.getType=function(){return this.opts.type};this.getTitle=function(){return this.opts.title};this.getInfoPoint=function(){return this.opts.infoPoint||this.map.getCenter()};this.visible=false;this.showPlacemark=function(){if(this.placemark){if(this.getType()=="array"){for(var E=0;E<this.placemark.length;E++){this.placemark[E].show()}}else{this.placemark.show()}this.visible=true}};this.hidePlacemark=function(){if(this.placemark){if(this.getType()=="array"){for(var E=0;E<this.placemark.length;E++){this.placemark[E].hide()}}else{this.placemark.hide()}this.visible=false}this.closeInfoWindow()};this.openInfoWindow=A.openInfoWindow||D.opts.openInfoWindow||D.timemap.opts.openInfoWindow||false;if(!this.openInfoWindow){if(this.opts.infoUrl!=""){this.openInfoWindow=TimeMapItem.openInfoWindowAjax}else{this.openInfoWindow=TimeMapItem.openInfoWindowBasic}}this.closeInfoWindow=A.closeInfoWindow||TimeMapItem.closeInfoWindowBasic}TimeMapItem.openInfoWindowBasic=function(){var A=this.opts.infoHtml;if(A==""){A='<div class="infotitle">'+this.opts.title+"</div>";if(this.opts.description!=""){A+='<div class="infodescription">'+this.opts.description+"</div>"}}if(this.placemark&&!this.visible&&this.event){var B=this.dataset.timemap.timeline.getBand(0);B.setCenterVisibleDate(this.event.getStart())}if(this.getType()=="marker"){this.placemark.openInfoWindowHtml(A)}else{this.map.openInfoWindowHtml(this.getInfoPoint(),A)}};TimeMapItem.openInfoWindowAjax=function(){if(this.opts.infoHtml!=""){this.openInfoWindow=TimeMapItem.openInfoWindowBasic;this.openInfoWindow()}else{if(this.opts.infoUrl!=""){var A=this;GDownloadUrl(this.opts.infoUrl,function(B){A.opts.infoHtml=B;A.openInfoWindow()})}else{this.openInfoWindow=TimeMapItem.openInfoWindowBasic;this.openInfoWindow()}}};TimeMapItem.closeInfoWindowBasic=function(){if(this.getType()=="marker"){this.placemark.closeInfoWindow()}else{var A=this.map.getInfoWindow();if(A.getPoint()==this.getInfoPoint()&&!A.isHidden()){this.map.closeInfoWindow()}}};function trim(A){return A.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function isArray(A){return A&&!(A.propertyIsEnumerable("length"))&&typeof A==="object"&&typeof A.length==="number"};